<script>
  const tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();

  const endpoint = "https://6d38ba529ace.ngrok-free.app/create-invoice";

  async function buy() {
    try {
      const userId = tg.initDataUnsafe?.user?.id;
      if (!userId) {
        tg.showAlert("Abra pelo Telegram ðŸ‘‰ Bot > Abrir Mini App");
        return;
      }

      const resp = await fetch(endpoint, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          item: "Premium 30 dias",
          stars: 500,
          init_data: tg.initData  // <-- importante para validaÃ§Ã£o no backend
        })
      });

      if (!resp.ok) {
        const msg = await resp.text();
        throw new Error(`Falha ${resp.status}: ${msg}`);
      }

      const { invoice_url } = await resp.json();
      if (!invoice_url) throw new Error("Sem invoice_url na resposta");

      tg.openInvoice(invoice_url, (status) => {
        if (status === "paid") tg.showAlert("Pagamento aprovado! ðŸŽ‰");
        else if (status === "cancelled") tg.showAlert("Pagamento cancelado.");
        else tg.showAlert("Pagamento falhou.");
      });
    } catch (e) {
      console.error(e);
      tg.showAlert("Erro ao criar cobranÃ§a. Tenta de novo.");
    }
  }

  document.getElementById("buy").addEventListener("click", buy);
</script>